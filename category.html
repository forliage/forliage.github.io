<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>分类文章</title>
    <link rel="stylesheet" href="style.css"> <!-- Assuming a shared style.css -->
    <link rel="stylesheet" href="modal.css">
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FPDBQB4LZD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-FPDBQB4LZD');
    </script>
</head>
<body>
    <audio id="bg-music" src="music.mp3" loop></audio>
    <button id="music-toggle" class="music-control">♪</button>
    <label class="dark-mode-control liquid-toggle">
        <input type="checkbox" id="dark-mode-toggle">
        <span class="knob"></span>
    </label>
    <header>
        <h1><span id="category-name"></span>下的文章</h1>
        <nav>
            <ul>
                <li><a href="index.html">首页</a></li>
                <li><a href="posts.html">文章</a></li>
                <li><a href="about.html">关于</a></li>
                <li><a href="category.html?category=技术文章">技术文章</a></li>
                <li><a href="category.html?category=生活随笔">生活随笔</a></li>
                <li><a href="category.html?category=学习笔记">学习笔记</a></li>
                <li><a href="category.html?category=心情日记">心情日记</a></li>
                <li><a href="#" id="about-me-btn">ABOUT ME</a></li>
            </ul>
        </nav>
    </header>
    <div class="container">
        <main>
            <!-- Container for posts in non-learning categories -->
            <div id="article-list">
                <!-- Articles will be listed here by JavaScript -->
            </div>
            <!-- New container for learning notes, hidden by default -->
            <div id="learning-notes-content" style="display: none;">
                <div id="search-container">
                    <input type="search" id="search-input" placeholder="在学习笔记中搜索标题...">
                    <div class="siri-wave"></div>
                </div>
                <div id="course-cards-container">
                    <!-- Course cards will be generated here -->
                </div>
            </div>
            <!-- New container for technical articles, hidden by default -->
            <div id="technical-articles-content" style="display: none;">
                <div id="search-container-tech">
                    <input type="search" id="search-input-tech" placeholder="在技术文章中搜索标题...">
                    <div class="siri-wave"></div>
                </div>
                <div id="technical-cards-container">
                    <!-- Technical article cards will be generated here -->
                </div>
            </div>
        </main>
    </div>
    <footer>
        <p>© 2025 我的博客</p>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const categoryNameElement = document.getElementById('category-name');
            const params = new URLSearchParams(window.location.search);
            const category = params.get('category');

            if (category) {
                categoryNameElement.textContent = category;
                document.title = category + " - 分类文章";
                fetchPostsForCategory(category);
            } else {
                const articleListElement = document.getElementById('article-list');
                categoryNameElement.textContent = '未指定分类';
                articleListElement.innerHTML = '<p>没有指定分类，无法加载文章。</p>';
            }
        });

        async function fetchPostsForCategory(category) {
            const articleListElement = document.getElementById('article-list');
            const learningNotesContainer = document.getElementById('learning-notes-content');
            const courseCardsContainer = document.getElementById('course-cards-container');
            const searchInput = document.getElementById('search-input');
            const technicalArticlesContainer = document.getElementById('technical-articles-content');
            const technicalCardsContainer = document.getElementById('technical-cards-container');
            const searchInputTech = document.getElementById('search-input-tech');

            let allPosts;
            try {
                const res = await fetch('./posts.json');
                if (!res.ok) throw new Error(res.statusText);
                allPosts = await res.json();
            } catch (err) {
                if (window.postsData) {
                    allPosts = window.postsData;
                } else {
                    articleListElement.innerHTML = '<p>加载文章列表时发生错误。</p>';
                    console.error(err);
                    return;
                }
            }

            const postsForCategory = allPosts.filter(p => p.category === category);

            if (postsForCategory.length === 0) {
                let container;
                if (category === '学习笔记') {
                    container = courseCardsContainer;
                    learningNotesContainer.style.display = 'block';
                    articleListElement.style.display = 'none';
                    technicalArticlesContainer.style.display = 'none';
                } else if (category === '技术文章') {
                    container = courseCardsContainer;
                    learningNotesContainer.style.display = 'block';
                    articleListElement.style.display = 'none';
                    technicalArticlesContainer.style.display = 'none';
                } else {
                    container = articleListElement;
                }
                container.innerHTML = `<p>“${category}”分类下暂无文章。</p>`;
                return;
            }

            if (category === '学习笔记') {
                learningNotesContainer.style.display = 'block';
                articleListElement.style.display = 'none';
                technicalArticlesContainer.style.display = 'none';
                renderLearningNotes(postsForCategory, courseCardsContainer);

                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredPosts = postsForCategory.filter(post =>
                        post.title.toLowerCase().includes(searchTerm)
                    );
                    renderLearningNotes(filteredPosts, courseCardsContainer);
                });
            } else if (category === '技术文章') {
                learningNotesContainer.style.display = 'block';
                articleListElement.style.display = 'none';
                technicalArticlesContainer.style.display = 'none';
                renderTechnicalArticles(postsForCategory, courseCardsContainer);

                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredPosts = postsForCategory.filter(post =>
                        post.title.toLowerCase().includes(searchTerm)
                    );
                    renderTechnicalArticles(filteredPosts, courseCardsContainer);
                });
            } else {
                articleListElement.innerHTML = '';
                postsForCategory.forEach(post => {
                    const article = document.createElement('article');
                    article.innerHTML = `
                        <h3><a class="post-link" href="${post.path}">${post.title}</a></h3>
                        <p>${post.abstract}</p>
                    `;
                    articleListElement.appendChild(article);
                });
            }
        }

        function renderLearningNotes(posts, container) {
            const courseIntroductions = {
                'ADS 课程笔记': '这里是浙江大学高级数据结构与算法(ADS)课程的笔记，经修缮后重新上传',
                'CUDA 学习笔记': 'CUDA学习笔记,基于NVIDIA官网手册',
                '计算机动画课程笔记': '这里是浙江大学研究生课程计算机动画的笔记',
                'DIP图像信息处理课程笔记': '这里是浙江大学图像信息处理(DIP)课程的笔记，经修缮后重新上传',
                '计算机组成课程笔记': '这里是浙江大学计算机组成(CO)课程的笔记，经修缮后重新上传',
                'x86汇编语言':'经学习浙江大学汇编语言(ASM)课程后整理的自己的一些理解',
                '计算机体系结构课程笔记':'这里是浙江大学计算机体系结构(CA)课程的笔记，经修缮后重新上传',
                '数据库系统课程笔记':'这里是浙江大学数据库系统(DB)课程的笔记，经修缮后重新上传',
                '数值分析课程笔记':'这里是浙江大学数值分析(NA)课程的笔记，经修缮后重新上传',
                '计算机图形学课程笔记': '这里是浙江大学计算机图形学(CG)课程的笔记，经修缮后重新上传',
                '线性代数(从算子角度理解)': '从算子角度重新理解线性代数，适合进阶理解线性代数的朋友，参考《线性代数应该这样学》',
                '计算理论': '这里是浙江大学计算理论课程的笔记，本学期将持续更新',
                '操作系统': '这里是浙江大学操作系统课程的笔记，本学期将持续更新',
                '计算机网络': '这里是浙江大学计算机网络课程的笔记，本学期将持续更新',
                '其他': '一些尚未分类的学习笔记。'
            };

            const groupedByCourse = posts.reduce((acc, post) => {
                let courseName = '其他';
                const lowerTitle = post.title.toLowerCase();
                if (lowerTitle.startsWith('ads')) {
                    courseName = 'ADS 课程笔记';
                } else if (lowerTitle.startsWith('cuda')) {
                    courseName = 'CUDA 学习笔记';
                } else if (lowerTitle.startsWith('计算机动画')) {
                    courseName = '计算机动画课程笔记';
                } else if (lowerTitle.startsWith('DIP') || lowerTitle.startsWith('图像信息处理') || lowerTitle.startsWith('dip')) {
                    courseName = 'DIP图像信息处理课程笔记';
                } else if (lowerTitle.startsWith('CO') || lowerTitle.startsWith('计算机组成')) {
                    courseName = '计算机组成课程笔记';
                } else if (lowerTitle.startsWith('asm') || lowerTitle.startsWith('x86汇编')) {
                    courseName = 'x86汇编语言';
                } else if (lowerTitle.startsWith('计算机体系结构')) {
                    courseName = '计算机体系结构课程笔记';
                } else if (lowerTitle.startsWith('数据库系统')) {
                    courseName = '数据库系统课程笔记';
                } else if (lowerTitle.startsWith('数值分析')) {
                    courseName = '数值分析课程笔记';
                } else if (lowerTitle.startsWith('计算机图形学')) {
                    courseName = '计算机图形学课程笔记';
                } else if (lowerTitle.startsWith('线性代数')) {
                    courseName = '线性代数(从算子角度理解)';
                } else if (lowerTitle.startsWith('计算理论')) {
                    courseName = '计算理论';
                } else if (lowerTitle.startsWith('操作系统')) {
                    courseName = '操作系统';
                } else if (lowerTitle.startsWith('计算机网络')) {
                    courseName = '计算机网络';
                }
                
                if (!acc[courseName]) {
                    acc[courseName] = [];
                }
                acc[courseName].push(post);
                return acc;
            }, {});

            container.innerHTML = '';
            
            if (posts.length === 0) {
                container.innerHTML = '<p style="text-align: center;">没有找到匹配的笔记。</p>';
                return;
            }

            let isPink = true;
            const courseNames = Object.keys(groupedByCourse).sort();

            for (const courseName of courseNames) {
                const coursePosts = groupedByCourse[courseName];
                
                const card = document.createElement('div');
                card.className = `course-card ${isPink ? 'course-card-pink' : 'course-card-white'}`;
                
                const introText = courseIntroductions[courseName] || '暂无简介。';
                card.innerHTML = `
                    <div class="card-header">
                        <h3>${courseName}</h3>
                        <p class="card-intro">${introText}</p>
                    </div>
                    <div class="card-body" style="display: none;">
                        <ul>
                            ${coursePosts.sort((a,b) => a.title.localeCompare(b.title)).map(post => `<li><a class="post-link" href="${post.path}">${post.title}</a></li>`).join('')}
                        </ul>
                    </div>
                `;
                
                container.appendChild(card);
                
                const header = card.querySelector('.card-header');
                header.addEventListener('click', () => {
                    const body = card.querySelector('.card-body');
                    card.classList.toggle('expanded');
                    body.style.display = card.classList.contains('expanded') ? 'block' : 'none';
                });
                
                isPink = !isPink;
            }
        }

        function renderTechnicalArticles(posts, container) {
            const technicalIntroductions = {
                '技术拓展': '一些技术方面的思考',
                '数学': '偶尔学习一下数学',
                '算法': '学习算法',
                '论文解析': '读论文,写一些想法和解释',
                '其他': '一些尚未分类的技术文章。'
            };

            const groupedBySubCategory = posts.reduce((acc, post) => {
                let subCategoryName = '其他';
                const lowerTitle = post.title.toLowerCase();
                if (lowerTitle.startsWith('技术拓展')) {
                    subCategoryName = '技术拓展';
                } else if (lowerTitle.startsWith('数学')) {
                    subCategoryName = '数学';
                } else if (lowerTitle.startsWith('算法')) {
                    subCategoryName = '算法';
                } else if (lowerTitle.startsWith('论文解析')) {
                    subCategoryName = '论文解析';
                }
                
                if (!acc[subCategoryName]) {
                    acc[subCategoryName] = [];
                }
                acc[subCategoryName].push(post);
                return acc;
            }, {});

            container.innerHTML = '';
            
            if (posts.length === 0) {
                container.innerHTML = '<p style="text-align: center;">没有找到匹配的文章。</p>';
                return;
            }

            let isPink = true;
            const subCategoryNames = Object.keys(groupedBySubCategory).sort();

            for (const subCategoryName of subCategoryNames) {
                const subCategoryPosts = groupedBySubCategory[subCategoryName];
                
                const card = document.createElement('div');
                card.className = `course-card ${isPink ? 'course-card-pink' : 'course-card-white'}`;
                
                const introText = technicalIntroductions[subCategoryName] || '暂无简介。';
                card.innerHTML = `
                    <div class="card-header">
                        <h3>${subCategoryName}</h3>
                        <p class="card-intro">${introText}</p>
                    </div>
                    <div class="card-body" style="display: none;">
                        <ul>
                            ${subCategoryPosts.sort((a,b) => a.title.localeCompare(b.title)).map(post => `<li><a class="post-link" href="${post.path}">${post.title}</a></li>`).join('')}
                        </ul>
                    </div>
                `;
                
                container.appendChild(card);
                
                const header = card.querySelector('.card-header');
                header.addEventListener('click', () => {
                    const body = card.querySelector('.card-body');
                    card.classList.toggle('expanded');
                    body.style.display = card.classList.contains('expanded') ? 'block' : 'none';
                });
                
                isPink = !isPink;
            }
        }
    </script>
    <script src="posts.js"></script>
    <div class="dock">
        <a href="https://forliage.github.io/index.html" data-icon="🏠">🏠</a>
        <a href="https://forliage.github.io/posts.html" data-icon="📚">📚</a>
        <a href="https://forliage.github.io/about.html" data-icon="👤">👤</a>
    </div>
    <script src="script.js"></script>
    <!-- The Modal -->
    <div id="about-me-modal" class="modal">
      <!-- Modal content -->
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>About Me</h2>
        <p>This is forliage, an undergraduate student of computer science and technology at Zhejiang University.</p>
        <p><strong>Motto:</strong> People always say that time heals all wounds, but I don't believe that. Time doen't heal the pain, it just makes us get used to pain. When you lose someone, you don't really forget them; you just learn how to live on without them.</p>
        <p><strong>Interests:</strong> Computer Graphics, Computer Version, Computer Animation, HPC, AIGC</p>
        <p><strong>Favorite Movie:</strong> The Shawshank Redemption, Dead Poets Society, Zootopia</p>
        <p><strong>Favorite Music:</strong> Blank Space, Sorega Daiji, Counting Stars, Whataya Want from Me</p>
        <p><strong>Contact Information:</strong>masterforliage@gmail.com</p>
        <hr>
        <h3>订阅我的博客</h3>
        <p>订阅功能正在建设中，敬请期待！</p>
      </div>
    </div>
    <script src="modal.js"></script>
    <script src="trail.js"></script>
</body>
</html>