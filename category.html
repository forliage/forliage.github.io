<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>分类文章</title>
    <link rel="stylesheet" href="style.css"> <!-- Assuming a shared style.css -->
</head>
<body>
    <audio id="bg-music" src="music.mp3" loop></audio>
    <button id="music-toggle" class="music-control">♪</button>
    <header>
        <h1><span id="category-name"></span>下的文章</h1>
        <nav>
            <ul>
                <li><a href="index.html">首页</a></li>
                <li><a href="posts.html">文章</a></li>
                <li><a href="about.html">关于</a></li>
                <li><a href="category.html?category=技术文章">技术文章</a></li>
                <li><a href="category.html?category=生活随笔">生活随笔</a></li>
                <li><a href="category.html?category=学习笔记">学习笔记</a></li>
                <li><a href="category.html?category=心情日记">心情日记</a></li>
            </ul>
        </nav>
    </header>
    <div class="container">
        <main>
            <!-- Container for posts in non-learning categories -->
            <div id="article-list">
                <!-- Articles will be listed here by JavaScript -->
            </div>
            <!-- New container for learning notes, hidden by default -->
            <div id="learning-notes-content" style="display: none;">
                <div id="search-container">
                    <input type="search" id="search-input" placeholder="在学习笔记中搜索标题...">
                </div>
                <div id="course-cards-container">
                    <!-- Course cards will be generated here -->
                </div>
            </div>
        </main>
    </div>
    <footer>
        <p>© 2025 我的博客</p>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const categoryNameElement = document.getElementById('category-name');
            const params = new URLSearchParams(window.location.search);
            const category = params.get('category');

            if (category) {
                categoryNameElement.textContent = category;
                document.title = category + " - 分类文章";
                fetchPostsForCategory(category);
            } else {
                const articleListElement = document.getElementById('article-list');
                categoryNameElement.textContent = '未指定分类';
                articleListElement.innerHTML = '<p>没有指定分类，无法加载文章。</p>';
            }
        });

        async function fetchPostsForCategory(category) {
            const articleListElement = document.getElementById('article-list');
            const learningNotesContainer = document.getElementById('learning-notes-content');
            const courseCardsContainer = document.getElementById('course-cards-container');
            const searchInput = document.getElementById('search-input');

            let allPosts;
            try {
                const res = await fetch('./posts.json');
                if (!res.ok) throw new Error(res.statusText);
                allPosts = await res.json();
            } catch (err) {
                if (window.postsData) {
                    allPosts = window.postsData;
                } else {
                    articleListElement.innerHTML = '<p>加载文章列表时发生错误。</p>';
                    console.error(err);
                    return;
                }
            }

            const postsForCategory = allPosts.filter(p => p.category === category);

            if (postsForCategory.length === 0) {
                const container = category === '学习笔记' ? courseCardsContainer : articleListElement;
                if (category === '学习笔记') {
                    learningNotesContainer.style.display = 'block';
                    articleListElement.style.display = 'none';
                }
                container.innerHTML = `<p>“${category}”分类下暂无文章。</p>`;
                return;
            }

            if (category === '学习笔记') {
                learningNotesContainer.style.display = 'block';
                articleListElement.style.display = 'none';
                renderLearningNotes(postsForCategory, courseCardsContainer);

                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredPosts = postsForCategory.filter(post =>
                        post.title.toLowerCase().includes(searchTerm)
                    );
                    renderLearningNotes(filteredPosts, courseCardsContainer);
                });
            } else {
                articleListElement.innerHTML = '';
                postsForCategory.forEach(post => {
                    const article = document.createElement('article');
                    article.innerHTML = `
                        <h3><a href="${post.path}">${post.title}</a></h3>
                        <p>${post.abstract}</p>
                    `;
                    articleListElement.appendChild(article);
                });
            }
        }

        function renderLearningNotes(posts, container) {
            const courseIntroductions = {
                'ADS 课程笔记': '这里是浙江大学高级数据结构与算法(ADS)课程的笔记，经修缮后重新上传',
                'CUDA 学习笔记': 'CUDA学习笔记,基于NVIDIA官网手册',
                '计算机动画课程笔记': '这里是浙江大学研究生课程计算机动画的笔记',
                'DIP图像信息处理课程笔记': '这里是浙江大学图像信息处理(DIP)课程的笔记，经修缮后重新上传',
                '计算机组成课程笔记': '这里是浙江大学计算机组成(CO)课程的笔记，经修缮后重新上传',
                '其他': '一些尚未分类的学习笔记。'
            };

            const groupedByCourse = posts.reduce((acc, post) => {
                let courseName = '其他';
                const lowerTitle = post.title.toLowerCase();
                if (lowerTitle.startsWith('ads')) {
                    courseName = 'ADS 课程笔记';
                } else if (lowerTitle.startsWith('cuda')) {
                    courseName = 'CUDA 学习笔记';
                } else if (lowerTitle.startsWith('计算机动画')) {
                    courseName = '计算机动画课程笔记';
                } else if (lowerTitle.startsWith('DIP') || lowerTitle.startsWith('图像信息处理') || lowerTitle.startsWith('dip')) {
                    courseName = 'DIP图像信息处理课程笔记';
                } else if (lowerTitle.startsWith('CO') || lowerTitle.startsWith('计算机组成')) {
                    courseName = '计算机组成课程笔记';
                }
                
                if (!acc[courseName]) {
                    acc[courseName] = [];
                }
                acc[courseName].push(post);
                return acc;
            }, {});

            container.innerHTML = '';
            
            if (posts.length === 0) {
                container.innerHTML = '<p style="text-align: center;">没有找到匹配的笔记。</p>';
                return;
            }

            let isPink = true;
            const courseNames = Object.keys(groupedByCourse).sort();

            for (const courseName of courseNames) {
                const coursePosts = groupedByCourse[courseName];
                
                const card = document.createElement('div');
                card.className = `course-card ${isPink ? 'course-card-pink' : 'course-card-white'}`;
                
                const introText = courseIntroductions[courseName] || '暂无简介。';
                card.innerHTML = `
                    <div class="card-header">
                        <h3>${courseName}</h3>
                        <p class="card-intro">${introText}</p>
                    </div>
                    <div class="card-body" style="display: none;">
                        <ul>
                            ${coursePosts.sort((a,b) => a.title.localeCompare(b.title)).map(post => `<li><a href="${post.path}">${post.title}</a></li>`).join('')}
                        </ul>
                    </div>
                `;
                
                container.appendChild(card);
                
                const header = card.querySelector('.card-header');
                header.addEventListener('click', () => {
                    const body = card.querySelector('.card-body');
                    card.classList.toggle('expanded');
                    body.style.display = card.classList.contains('expanded') ? 'block' : 'none';
                });
                
                isPink = !isPink;
            }
        }
    </script>
    <script src="posts.js"></script>
    <script src="script.js"></script>
    <script src="analytics.js"></script>
</body>
</html>