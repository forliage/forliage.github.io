---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";

const categories = [
    {
        id: "views",
        title: "Technical Views",
        description: "Personal insights on software trends and engineering philosophy.",
        link: "/blog/tech/views",
        color: "#f1c40f", // Yellow
    },
    {
        id: "papers",
        title: "Paper Insights",
        description: "Deep dives into academic research and breakthrough algorithms.",
        link: "/blog/tech/papers",
        color: "#fa7298", // Pink
    },
    {
        id: "tips",
        title: "Common Tips",
        description: "A collection of practical engineering tricks and daily shortcuts.",
        link: "/blog/tech/tips",
        color: "#ff9800", // Orange
    }
];
---

<Layout title="Technique Discussion - Liuye Zhao">
    <Header />

    <main class="tech-page">
        <!-- Background Meteors Container -->
        <div id="meteors-container"></div>

        <!-- Back Button -->
        <a href="/blog" class="back-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            Back
        </a>

        <div class="page-header">
            <h1 class="page-title">Technique Discussion</h1>
            <p class="page-subtitle">Exploration, analysis, and engineering wisdom.</p>
        </div>

        <div class="doors-container">
            {categories.map((cat) => (
                // Pass color as CSS variable for local scope
                <div class="door-wrapper" style={`--accent-color: ${cat.color}`}>
                    <div class="door-label-top">
                        <h3>{cat.title}</h3>
                        <p>{cat.description}</p>
                    </div>

                    <a href={cat.link} class="door-cube-scene" id={`scene-${cat.id}`}>
                        <div class="cube-assembly">
                            <!-- Only Front Frame and Back Screen (Tunnel sides removed) -->
                            <div class="face front-frame"></div>
                            <div class="face back-screen">
                                <!-- Pass color to script via data attribute -->
                                <canvas class="starfield-canvas" data-color={cat.color}></canvas>
                            </div>
                        </div>
                    </a>

                    <a href={cat.link} class="enter-btn">ENTER</a>
                </div>
            ))}
        </div>
    </main>
</Layout>

<script>
    class StarfieldEngine {
        canvas: HTMLCanvasElement;
        ctx: CanvasRenderingContext2D;
        stars: { x: number; y: number; z: number; size: number; opacity: number; opacitySpeed: number }[];
        width!: number;
        height!: number;
        centerX!: number;
        centerY!: number;
        baseColor: string;
        animationId!: number;

        constructor(canvas: HTMLCanvasElement) {
            this.canvas = canvas;
            this.ctx = canvas.getContext('2d', { alpha: false })!;
            this.stars = [];
            // Read color from data attribute, default to white
            this.baseColor = canvas.dataset.color || '#ffffff';
            
            this.resize();
            this.initStars(400); 
            this.animate();

            const observer = new ResizeObserver(() => this.resize());
            observer.observe(canvas);
        }

        resize() {
            this.width = this.canvas.width = this.canvas.clientWidth;
            this.height = this.canvas.height = this.canvas.clientHeight;
            this.centerX = this.width / 2;
            this.centerY = this.height / 2;
        }

        initStars(count: number) {
            this.stars = [];
            for (let i = 0; i < count; i++) {
                this.stars.push(this.createStar(true)); 
            }
        }

        createStar(randomZ = false) {
            return {
                x: (Math.random() - 0.5) * this.width * 3, 
                y: (Math.random() - 0.5) * this.height * 3,
                z: randomZ ? Math.random() * 1000 : 1000, 
                size: Math.random() * 2 + 0.5,
                opacity: Math.random(),
                opacitySpeed: Math.random() * 0.05 + 0.01
            };
        }

        animate() {
            // Clear with SOLID BLACK
            this.ctx.fillStyle = '#000000';
            this.ctx.fillRect(0, 0, this.width, this.height);

            const speed = 8; 

            this.stars.forEach(star => {
                star.z -= speed;

                // Blinking effect
                star.opacity += star.opacitySpeed;
                if (star.opacity > 1 || star.opacity < 0.2) star.opacitySpeed *= -1;

                if (star.z <= 1) {
                    Object.assign(star, this.createStar(false));
                }

                // Project 3D to 2D
                const k = 128.0 / star.z;
                const px = star.x * k + this.centerX;
                const py = star.y * k + this.centerY;

                // Only draw if within bounds
                if (px >= 0 && px <= this.width && py >= 0 && py <= this.height) {
                    const scaleSize = (1 - star.z / 1000) * 4 * star.size;
                    
                    this.ctx.beginPath();
                    // Use the specific color
                    this.ctx.fillStyle = this.hexToRgba(this.baseColor, Math.max(0, Math.min(1, star.opacity)));
                    this.ctx.arc(px, py, Math.max(0.5, scaleSize), 0, Math.PI * 2);
                    this.ctx.fill();
                }
            });

            this.animationId = requestAnimationFrame(() => this.animate());
        }

        hexToRgba(hex: string, alpha: number) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        // Init Background Meteors
        const meteorsContainer = document.getElementById("meteors-container");
        if (meteorsContainer) {
            const createMeteor = () => {
                const meteor = document.createElement("div");
                meteor.classList.add("meteor");
                meteor.style.left = `${Math.random() * 120}%`;
                meteor.style.top = `${Math.random() * 100 - 50}%`;
                meteor.style.width = `${Math.random() * 100 + 50}px`;
                meteor.style.animationDuration = `${Math.random() * 1 + 1}s`;
                meteorsContainer.appendChild(meteor);
                setTimeout(() => meteor.remove(), 2000);
            };
            setInterval(createMeteor, 300);
        }

        // Init Canvases
        document.querySelectorAll('.starfield-canvas').forEach(canvas => {
            new StarfieldEngine(canvas as HTMLCanvasElement);
        });
    });
</script>

<style>
    :root {
        --door-w: 280px;
        --door-h: 420px;
        --primary-bg: #fafffa; 
        --primary-text: #333;
    }

    body, html {
        margin: 0; padding: 0;
        overflow-x: hidden; width: 100%;
    }

    .tech-page {
        min-height: 100vh;
        padding: 6rem 2rem;
        background: var(--primary-bg);
        color: var(--primary-text);
        position: relative;
        overflow-x: hidden;
        overflow-y: hidden; 
    }

    /* Common UI Elements */
    .back-button {
        position: fixed; top: 100px; left: 2rem; z-index: 100;
        display: flex; align-items: center; gap: 8px; padding: 12px 20px;
        background: rgba(255, 240, 245, 0.7); backdrop-filter: blur(10px);
        border: 1px solid rgba(240, 117, 174, 0.3); border-radius: 50px;
        color: #f075ae; text-decoration: none; transition: 0.3s;
    }
    .back-button:hover { background: rgba(240, 117, 174, 0.2); }

    .page-header { text-align: center; margin-bottom: 5rem; position: relative; z-index: 10; }
    .page-title {
        font-size: 3.5rem; font-weight: 800; margin-bottom: 0.5rem;
        background: linear-gradient(120deg, #f075ae, #a18cd1);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .page-subtitle { color: #555; font-size: 1.1rem; }

    /* Meteors */
    #meteors-container { position: fixed; inset: 0; pointer-events: none; }
    :global(.meteor) {
        position: absolute; height: 2px;
        background: linear-gradient(90deg, #a18cd1, transparent);
        opacity: 0; transform: rotate(-45deg);
        animation: shower linear;
    }
    @keyframes shower {
        0% { opacity: 0; transform: rotate(-45deg) translateX(0); }
        10% { opacity: 0.7; }
        100% { opacity: 0; transform: rotate(-45deg) translateX(-1000px); }
    }

    /* --- The Door Assembly --- */
    .doors-container {
        display: flex; justify-content: center; gap: 6rem; flex-wrap: wrap;
        perspective: 2000px; z-index: 10; position: relative;
        max-width: 100%;
    }

    .door-wrapper {
        display: flex; flex-direction: column; align-items: center; gap: 2rem;
        position: relative;
    }

    .door-label-top { text-align: center; max-width: 260px; z-index: 20; pointer-events: none;}
    .door-label-top h3 { font-size: 1.6rem; margin: 0 0 0.5rem 0; color: #222; }
    .door-label-top p { color: #666; font-size: 0.9rem; margin: 0; }

    /* The interactive container */
    .door-cube-scene {
        width: 300px; height: 440px; 
        position: relative;
        display: flex; justify-content: center; align-items: center;
        perspective: 1000px; 
        text-decoration: none;
    }

    /* The 3D Assembly (Now flattened visually) */
    .cube-assembly {
        width: var(--door-w); height: var(--door-h);
        position: relative;
        transform-style: preserve-3d;
        transform: rotateY(-10deg); 
        transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    
    .door-cube-scene:hover .cube-assembly {
        transform: rotateY(0deg) scale(1.05); /* Slight pop, face front */
    }

    /* Front Frame (Liuli/Glass Style) */
    .front-frame {
        position: absolute; width: 100%; height: 100%;
        border-radius: 12px; /* Slightly rounder key */
        border: 2px solid rgba(255,255,255,0.2);
        
        /* 
           Simulate Thick Colored Glass (Liuli)
           1. Inset Shadow for Volume (Colored)
           2. Inner Highlight (White) for Specular Reflection
           3. Inner Shadow (Black) for Depth
           4. Outer Glow (Colored) for Emission
        */
        box-shadow: 
            /* Main Body of Glass (Thick Inner Rim) */
            inset 0 0 20px rgba(0,0,0,0.5),
            
            /* Inner Colored Glow (The 'Soul') */
            inset 0 0 10px var(--accent-color),
            
            /* Top-Left Specular Highlight (The 'Shine') */
            inset 2px 2px 5px rgba(255,255,255,0.9),
            
            /* Bottom-Right Deep Shadow (The 'Weight') */
            inset -2px -2px 5px rgba(0,0,0,0.5),
            
            /* Outer Colored Aura */
            0 0 15px var(--accent-color);
            
        /* Glass Texture Base */
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(2px);
        transform: translateZ(0); 
        pointer-events: none;
        z-index: 20;
    }
    
    /* Back Screen (Canvas) */
    .back-screen {
        position: absolute; width: 100%; height: 100%;
        background: #000;
        /* Flush with frame */
        transform: translateZ(-2px); 
        display: flex; overflow: hidden;
    }
    
    .starfield-canvas { width: 100%; height: 100%; }

    /* Enter Button (Dynamic Color) */
    .enter-btn {
        margin-top: 1rem; padding: 10px 40px;
        border: 2px solid var(--accent-color);
        color: var(--accent-color);
        border-radius: 4px; text-decoration: none;
        letter-spacing: 2px; font-weight: 700; transition: 0.3s;
    }
    .enter-btn:hover {
        background: var(--accent-color); 
        color: #fff; 
        box-shadow: 0 0 20px var(--accent-color);
    }
</style>
