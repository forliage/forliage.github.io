---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
---

<Layout title="Blog - Liuye Zhao">
    <Header />
    <main class="blog-hub">
        <!-- Sakura Canvas -->
        <canvas id="sakura-canvas"></canvas>

        <!-- Blur Overlay for Signature Mode -->
        <div id="signature-overlay" class="signature-overlay">
            <div class="signature-container">
                <!-- SVG Signature using Text with Legacy Font -->
                <svg viewBox="0 0 1000 300" class="signature-svg">
                    <defs>
                        <linearGradient
                            id="gradient"
                            x1="0%"
                            y1="0%"
                            x2="100%"
                            y2="0%"
                        >
                            <stop
                                offset="0%"
                                style="stop-color:#f075ae;stop-opacity:1"
                            ></stop>
                            <stop
                                offset="100%"
                                style="stop-color:#5dd3b6;stop-opacity:1"
                            ></stop>
                        </linearGradient>
                    </defs>

                    <!-- 
                       Legacy Font Stack: "Snell Roundhand", "Brush Script MT", cursive
                       Text: "Hello. This is forliage"
                    -->
                    <text
                        id="sig-text"
                        x="50%"
                        y="50%"
                        dominant-baseline="middle"
                        text-anchor="middle"
                        fill="transparent"
                        stroke="url(#gradient)"
                        stroke-width="2"
                        style="font-family: 'Snell Roundhand', 'Brush Script MT', cursive; font-size: 100px; letter-spacing: 2px;"
                    >
                        Hello. This is forliage
                    </text>
                </svg>
            </div>
        </div>

        <div class="center-content">
            <!-- Container for the typing effect with Reflection -->
            <div class="welcome-wrapper">
                <h1 class="welcome-text">
                    <span id="typewriter"></span><span class="cursor">|</span>
                </h1>
                <h1 class="welcome-text reflection" aria-hidden="true">
                    <span id="typewriter-reflection"></span><span class="cursor"
                        >|</span
                    >
                </h1>
            </div>

            <!-- Liquid Glass Button -->
            <div class="signature-trigger-wrapper">
                <button id="signature-btn" class="liquid-button">
                    <span>Signature</span>
                    <div class="liquid"></div>
                </button>
            </div>
        </div>

        <aside class="sidebar-nav">
            <nav>
                <ul>
                    <!-- Applied liquid-button class-like styles to these links via CSS below -->
                    <li>
                        <a href="/blog/tech" class="sidebar-link"
                            >Technique Discussion</a
                        >
                    </li>
                    <li>
                        <a href="/blog/zju" class="sidebar-link"
                            >ZJU Lecture Notes</a
                        >
                    </li>
                    <li>
                        <a href="/blog/others" class="sidebar-link"
                            >Other Lecture Notes</a
                        >
                    </li>
                    <li>
                        <a href="/blog/life" class="sidebar-link"
                            >Reflections and Life</a
                        >
                    </li>
                </ul>
            </nav>
        </aside>
    </main>
</Layout>

<script>
    // --- Typewriter Logic ---
    const textToType = "Welcome to forliage's life";
    const typeSpeed = 100;
    const deleteSpeed = 50;
    const pauseBeforeDelete = 2000;
    const pauseBeforeRestart = 500;

    const typewriterElement = document.getElementById("typewriter");
    const typewriterReflection = document.getElementById(
        "typewriter-reflection",
    );

    if (typewriterElement && typewriterReflection) {
        let charIndex = 0;
        let isDeleting = false;

        function type() {
            const currentString = textToType;
            let currentText = "";

            if (isDeleting) {
                currentText = currentString.substring(0, charIndex - 1);
                charIndex--;
            } else {
                currentText = currentString.substring(0, charIndex + 1);
                charIndex++;
            }

            if (typewriterElement) typewriterElement.textContent = currentText;
            if (typewriterReflection)
                typewriterReflection.textContent = currentText;

            let delta = isDeleting ? deleteSpeed : typeSpeed;

            if (!isDeleting && charIndex === currentString.length) {
                delta = pauseBeforeDelete;
                isDeleting = true;
            } else if (isDeleting && charIndex === 0) {
                delta = pauseBeforeRestart;
                isDeleting = false;
            }

            setTimeout(type, delta);
        }
        setTimeout(type, 500);
    }

    // --- Signature Animation Logic ---
    const signatureBtn = document.getElementById("signature-btn");
    const overlay = document.getElementById("signature-overlay");
    const sigText = document.getElementById(
        "sig-text",
    ) as unknown as SVGTextElement;

    if (signatureBtn && overlay && sigText) {
        // Use a safe large value for text stroke length
        const pathLength = 3000;

        sigText.style.strokeDasharray = pathLength.toString();
        sigText.style.strokeDashoffset = pathLength.toString();

        signatureBtn.addEventListener("click", () => {
            overlay.classList.add("active");

            setTimeout(() => {
                sigText.style.transition = "stroke-dashoffset 4s ease-in-out";
                sigText.style.strokeDashoffset = "0";
            }, 500);

            setTimeout(() => {
                overlay.classList.remove("active");
                setTimeout(() => {
                    sigText.style.transition = "none";
                    sigText.style.strokeDashoffset = pathLength.toString();
                }, 1000);
            }, 6000);
        });
    }

    // --- Sakura Animation Logic ---
    const canvas = document.getElementById(
        "sakura-canvas",
    ) as HTMLCanvasElement;
    if (canvas) {
        const ctx = canvas.getContext("2d");

        let width = 0;
        let height = 0;

        const resize = () => {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        };

        window.addEventListener("resize", resize);
        resize();

        interface Petal {
            x: number;
            y: number;
            z: number; // Depth: 0 (Front) to 1 (Back)
            vx: number;
            vy: number;
            rotation: number;
            rotationSpeed: number;
            flip: number; // 3D Flip angle
            flipSpeed: number;
            size: number;
            color: string;
            landed: boolean;
            landX: number; // Store landing position
            landY: number; // Store landing position
        }

        const petals: Petal[] = [];
        const landedPetals: Petal[] = [];

        // Configuration
        const MAX_PETALS = 200;
        const MAX_LANDED = 800;
        const GROUND_DEPTH_HEIGHT = 200; // How far up the screen the "back" of the ground is

        const createPetal = (startY?: number): Petal => {
            const colors = ["#ffc0cb", "#ffb7c5", "#ffc3d0", "#ffd1dc"];
            const z = Math.random(); // 0 = Close, 1 = Far

            // Perspective scales
            // Close (z=0) -> Scale 1.2, Fast
            // Far (z=1) -> Scale 0.4, Slow
            const scale = 1.2 - z * 0.8;

            // Start above screen
            const x = Math.random() * width;
            const y = startY !== undefined ? startY : -20;

            return {
                x: x,
                y: y,
                z: z,
                // Speed depends on depth (parallax)
                vx: (Math.random() - 0.5) * 2 * scale,
                vy: (1.5 + Math.random() * 2) * scale,

                rotation: Math.random() * 360,
                rotationSpeed: (Math.random() - 0.5) * 2,
                flip: Math.random() * Math.PI,
                flipSpeed: (Math.random() - 0.5) * 0.1,

                size: (8 + Math.random() * 5) * scale,
                color: colors[Math.floor(Math.random() * colors.length)],
                landed: false,
                landX: 0,
                landY: 0,
            };
        };

        // Initialize
        for (let i = 0; i < 80; i++) {
            petals.push(createPetal(Math.random() * height));
        }

        const drawPetal = (p: Petal) => {
            if (!ctx) return;
            ctx.save();
            ctx.translate(p.x, p.y);

            // 3D Flip calculation
            // We scale the Y axis of the petal based on sin(flip) to simulate rotation
            const flipScale = Math.abs(Math.cos(p.flip));

            ctx.rotate((p.rotation * Math.PI) / 180);
            ctx.scale(1, flipScale); // Apply 3D flip effect

            ctx.fillStyle = p.color;
            // Far petals are slightly more transparent / blurry logic could go here
            ctx.globalAlpha = 0.8 - p.z * 0.3; // Fade out far petals

            // Dynamic Shape
            ctx.beginPath();
            // A slightly more detailed petal shape
            const s = p.size;
            ctx.moveTo(0, -s / 2);
            ctx.bezierCurveTo(s / 2, -s / 2, s, 0, 0, s);
            ctx.bezierCurveTo(-s, 0, -s / 2, -s / 2, 0, -s / 2);
            ctx.fill();

            ctx.restore();
        };

        const update = () => {
            if (!ctx) return;
            ctx.clearRect(0, 0, width, height);

            // Sort landed petals by depth (Z) so correct ones overwite others?
            // Actually for "painter's algorithm" we want far (high Z) drawn first.
            // But here Z is 0..1, 1 is far. So we should draw high Z first.
            // Landed petals list might change, better not sort every frame if possible.
            // For simple transparency overlap, sorting helps but maybe overkill for CPU.
            // Let's just draw.

            // Add new
            if (petals.length < MAX_PETALS && Math.random() > 0.92) {
                petals.push(createPetal());
            }

            // Update state
            for (let i = petals.length - 1; i >= 0; i--) {
                const p = petals[i];
                if (!p.landed) {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.rotation += p.rotationSpeed;
                    p.flip += p.flipSpeed;

                    // Wind sway based on depth
                    p.x +=
                        Math.sin(Date.now() * 0.001 + p.z * 10) *
                        0.5 *
                        (1 - p.z);

                    // Landing Logic
                    // Calculate "Ground Level" for this specific Z depth.
                    // Far objects (z=1) land higher up. Close objects (z=0) land at bottom.
                    const groundLevel = height - p.z * GROUND_DEPTH_HEIGHT;

                    if (p.y >= groundLevel) {
                        p.landed = true;
                        p.y = groundLevel + (Math.random() * 10 - 5); // Small variation
                        p.landX = p.x;
                        p.landY = p.y;
                        landedPetals.push(p);
                        petals.splice(i, 1);
                    } else {
                        drawPetal(p);
                    }
                }
            }

            // Management of landed petals
            if (landedPetals.length > MAX_LANDED) {
                landedPetals.shift();
            }

            // Draw landed
            for (const p of landedPetals) {
                drawPetal(p);
            }

            requestAnimationFrame(update);
        };

        update();
    }
</script>

<style>
    :root {
        --text-color: #333;
        --highlight-color: #f075ae;
        --apple-font:
            -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI",
            Roboto, Helvetica, Arial, sans-serif;
        --sidebar-font: "Outfit", "Montserrat", var(--apple-font);
    }

    .blog-hub {
        display: flex;
        min-height: 80vh;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        padding: 2rem;
        font-family: var(--apple-font);
    }

    /* Sakura Canvas */
    #sakura-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1; /* Background effect, behind interactive elements but visible */
    }

    .center-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10;
        min-height: 200px;
    }

    .welcome-wrapper {
        position: relative;
        margin-bottom: 3rem;
    }

    .welcome-text {
        font-size: 4rem;
        font-weight: 700;
        color: var(--highlight-color);
        letter-spacing: 1px;
        text-shadow: 0 4px 15px rgba(240, 117, 174, 0.3);
        display: flex;
        align-items: center;
        margin: 0;
        line-height: 1.2;
    }

    .welcome-text.reflection {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        transform: scaleY(-0.6) translateY(-10px);
        opacity: 0.3;
        mask-image: linear-gradient(
            to bottom,
            transparent,
            transparent 20%,
            black
        );
        -webkit-mask-image: linear-gradient(
            to top,
            rgba(0, 0, 0, 0.5),
            transparent
        );
        pointer-events: none;
        filter: blur(2px);
    }

    .cursor {
        display: inline-block;
        color: var(--highlight-color);
        font-weight: 100;
        animation: blink 1s step-end infinite;
        margin-left: 5px;
    }

    @keyframes blink {
        0%,
        100% {
            opacity: 1;
        }
        50% {
            opacity: 0;
        }
    }

    /* --- Liquid Glass Button Styles (Shared) --- */
    .liquid-button,
    .sidebar-link {
        position: relative;
        font-weight: 700;
        background: rgba(
            255,
            255,
            255,
            0.65
        ); /* More transparent for glass feel */
        border: 1px solid rgba(240, 117, 174, 0.3);
        border-radius: 50px;
        cursor: pointer;
        outline: none;
        overflow: hidden;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow:
            0 8px 32px 0 rgba(240, 117, 174, 0.15),
            inset 0 0 0 1px rgba(255, 255, 255, 0.5);
        transition: all 0.4s ease;
        font-family: var(--apple-font);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Specifics for main trigger button */
    .liquid-button {
        padding: 12px 36px;
        font-size: 1.1rem;
        color: #e65297;
    }

    /* Sidebar Link Specifics */
    .sidebar-link {
        display: block;
        padding: 12px 24px;
        font-size: 1rem;
        color: #555; /* Neutral color initially */
        text-decoration: none;
        margin-bottom: 0.5rem;
        text-align: center;
        width: 100%;
        box-sizing: border-box;
    }

    .liquid-button:hover,
    .sidebar-link:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow:
            0 15px 30px rgba(240, 117, 174, 0.3),
            inset 0 0 20px rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.9);
        color: #d13075; /* Pink on hover for sidebar too */
        border-color: rgba(240, 117, 174, 0.6);
    }

    /* Shine effect for both */
    .liquid-button::before,
    .sidebar-link::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(240, 117, 174, 0.2),
            transparent
        );
        transition: left 0.5s;
    }

    .liquid-button:hover::before,
    .sidebar-link:hover::before {
        left: 100%;
    }

    /* --- Sidebar Container --- */
    .sidebar-nav {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 320px;
        display: flex;
        align-items: center;
        padding-left: 20px;
        padding-right: 40px; /* Add padding for buttons */
        z-index: 20; /* Fixed: Higher than center-content */
        pointer-events: none; /* Let clicks pass through empty areas */
    }

    .sidebar-nav nav {
        width: 100%;
        pointer-events: auto; /* Re-enable clicks on nav */
    }

    .sidebar-nav nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .sidebar-nav nav li {
        transform: translateX(50px);
        opacity: 0;
        animation: slideIn 0.5s ease-out forwards;
    }

    .sidebar-nav nav li:nth-child(1) {
        animation-delay: 0.2s;
    }
    .sidebar-nav nav li:nth-child(2) {
        animation-delay: 0.3s;
    }
    .sidebar-nav nav li:nth-child(3) {
        animation-delay: 0.4s;
    }
    .sidebar-nav nav li:nth-child(4) {
        animation-delay: 0.5s;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(50px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* --- Signature Overlay --- */
    .signature-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 999;
        pointer-events: none;
        opacity: 0;
        backdrop-filter: blur(0px);
        background: rgba(255, 255, 255, 0.2);
        transition:
            opacity 0.5s ease,
            backdrop-filter 0.5s ease;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .signature-overlay.active {
        opacity: 1;
        backdrop-filter: blur(25px);
        pointer-events: auto;
    }

    .signature-container {
        width: 90%;
        max-width: 1000px;
    }

    .signature-svg {
        width: 100%;
        height: auto;
        overflow: visible;
        filter: drop-shadow(0 0 5px rgba(240, 117, 174, 0.5));
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .blog-hub {
            flex-direction: column;
            padding-top: 4rem;
        }

        .welcome-text {
            font-size: 2.5rem;
            text-align: center;
            justify-content: center;
        }

        .welcome-text.reflection {
            display: none;
        }

        .sidebar-nav {
            position: relative;
            width: 100%;
            padding: 2rem;
            justify-content: center;
            z-index: 20;
        }

        .sidebar-nav nav ul {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .sidebar-nav nav li {
            transform: translateY(20px);
            animation-name: fadeInUp;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    }
</style>
