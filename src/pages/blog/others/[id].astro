---
import Layout from "../../../layouts/Layout.astro";
import Header from "../../../components/Header.astro";

export async function getStaticPaths() {
    const planets = [
        { id: "cmu-15-462", color: "#ff6b6b", title: "CMU 15-462" },
        { id: "cmu-15-458", color: "#4dabf7", title: "CMU 15-458" },
        { id: "stanford-cs231n", color: "#69db7c", title: "Stanford CS231n" },
        { id: "ucsd-cse-272", color: "#da77f2", title: "UCSD CSE 272" },
        { id: "games-101", color: "#ffa94d", title: "Games 101" },
        { id: "games-202", color: "#adb5bd", title: "Games 202" },
    ];
    return planets.map((p) => ({
        params: { id: p.id },
        props: { planet: p },
    }));
}

const { id } = Astro.params;
const { planet } = Astro.props;
---

<Layout title={`${planet.title} - Landing Surface`}>
    <Header />
    <main class="landing-container">
        <!-- Overlay UI -->
        <div class="ui-overlay">
            <a href="/blog/others" class="btn-back">
                <span class="icon">ðŸš€</span> LEAVE PLANET
            </a>
            <div class="planet-title-card">
                <h1>{planet.title}</h1>
                <div class="status-badge">ATMOSPHERE: STABLE</div>
            </div>
        </div>

        <!-- 3D Environment Canvas -->
        <div id="landing-canvas-container" data-planet-color={planet.color}>
        </div>
    </main>
</Layout>

<script>
    import * as THREE from "three";

    // Typed declarations for Three.js objects
    let scene: THREE.Scene;
    let camera: THREE.PerspectiveCamera;
    let renderer: THREE.WebGLRenderer;
    let terrain: THREE.Mesh;
    let requestID: number;

    const container = document.getElementById(
        "landing-canvas-container",
    ) as HTMLDivElement;
    const planetColor = container?.dataset.planetColor || "#ffffff";

    function init() {
        if (!container) return;

        // 1. Scene Setup
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0c);
        scene.fog = new THREE.FogExp2(0x1a1a1e, 0.04);

        // 2. Camera Setup
        const aspect = window.innerWidth / window.innerHeight;
        camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 2000);
        camera.position.set(0, 12, 50);
        camera.lookAt(0, 5, 0);

        // 3. Renderer Setup
        renderer = new THREE.WebGLRenderer({
            antialias: true,
            powerPreference: "high-performance",
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // 4. Lighting
        const sun = new THREE.DirectionalLight(0xffffff, 5.0);
        sun.position.set(100, 150, 50);
        sun.castShadow = true;
        sun.shadow.mapSize.set(2048, 2048);
        sun.shadow.camera.left = -100;
        sun.shadow.camera.right = 100;
        sun.shadow.camera.top = 100;
        sun.shadow.camera.bottom = -100;
        scene.add(sun);

        const fillLight = new THREE.PointLight(planetColor, 25, 100);
        fillLight.position.set(-30, 20, 10);
        scene.add(fillLight);

        const amb = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(amb);

        // 5. Geometry & Objects
        generateTerrain();
        addRocks();

        animate();
    }

    function generateTerrain() {
        const size = 500;
        const resolution = 256; // High density for more detail
        const geo = new THREE.PlaneGeometry(size, size, resolution, resolution);
        geo.rotateX(-Math.PI / 2);

        const pos = geo.attributes.position;
        for (let i = 0; i < pos.count; i++) {
            const x = pos.getX(i);
            const z = pos.getZ(i);

            // Fractal Brownian Motion (FBM) with more octaves for sharper hills
            let y = 0;
            y += Math.sin(x * 0.04) * Math.cos(z * 0.04) * 12.0;
            y += Math.sin(x * 0.15) * Math.sin(z * 0.15) * 4.0;
            y += Math.sin(x * 0.4) * Math.cos(z * 0.4) * 1.5;
            y += (Math.random() - 0.5) * 0.2; // Tiny surface roughness
            pos.setY(i, y);
        }
        geo.computeVertexNormals();

        const mat = new THREE.MeshStandardMaterial({
            color: new THREE.Color(planetColor),
            roughness: 0.65, // Lower roughness for more defined highlights
            metalness: 0.2,
            flatShading: false, // Smooth shading but with more geometry detail
        });

        terrain = new THREE.Mesh(geo, mat);
        terrain.receiveShadow = true;
        scene.add(terrain);
    }

    function addRocks() {
        const rockCount = 60;
        for (let i = 0; i < rockCount; i++) {
            const size = Math.random() * 4 + 1;
            const bGeo = new THREE.DodecahedronGeometry(size, 0);

            // Crystalline/Refractive material
            const bMat = new THREE.MeshPhysicalMaterial({
                color: planetColor,
                roughness: 0.1,
                metalness: 0.4,
                ior: 1.5,
                transmission: 0.6,
                thickness: 2,
                transparent: true,
                opacity: 0.9,
                reflectivity: 0.5,
            });

            const rock = new THREE.Mesh(bGeo, bMat);
            const rx = (Math.random() - 0.5) * 200;
            const rz = (Math.random() - 0.5) * 200;

            // Basic ground estimation for rock height
            const ry =
                Math.sin(rx * 0.05) * Math.cos(rz * 0.05) * 8.0 +
                Math.sin(rx * 0.2) * Math.sin(rz * 0.2) * 2.5 -
                size * 0.5;

            rock.position.set(rx, ry, rz);
            rock.rotation.set(
                Math.random() * Math.PI,
                Math.random() * Math.PI,
                0,
            );
            rock.castShadow = true;
            rock.receiveShadow = true;
            scene.add(rock);
        }
    }

    function animate() {
        requestID = requestAnimationFrame(animate);
        const time = Date.now() * 0.0005;

        // Subtle cinematic camera pan
        camera.position.x = Math.sin(time * 0.1) * 10;
        camera.lookAt(0, 5, -20);

        renderer.render(scene, camera);
    }

    // Cleanup on window resize
    const handleResize = () => {
        if (!camera || !renderer) return;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    };

    window.addEventListener("resize", handleResize);

    // Initial call
    init();
</script>

<style>
    .landing-container {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        background: #000;
        font-family: "Outfit", sans-serif;
    }
    #landing-canvas-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    .ui-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 100;
        padding: 30px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: flex-start; /* Title to side */
    }

    .btn-back {
        pointer-events: auto;
        text-decoration: none;
        color: #fff;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 10px 20px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.9rem;
        transition: all 0.3s;
    }
    .btn-back:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.05);
    }

    .planet-title-card {
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(10px);
        padding: 20px 30px;
        border-radius: 15px;
        border-left: 4px solid #fff;
        margin: 20px;
    }
    h1 {
        font-size: 1.8rem;
        text-transform: uppercase;
        letter-spacing: 4px;
        font-weight: 900;
        margin-bottom: 5px;
        color: #fff;
    }
    .status-badge {
        color: #0f0;
        font-weight: 800;
        letter-spacing: 2px;
        font-size: 0.65rem;
    }
</style>
