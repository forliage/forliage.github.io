---
title: "计算机动画06:群组动画(下)"
description: ""
pubDate: "2025-08-23"
heroImage: ""
---

# 计算机动画06:群组动画(下)

### **第一部分：基于社会力模型的群体行为模拟**

#### **1\. 问题的提出：当秩序崩溃时**

首先，我想让大家看几张触目惊心的图片。这些并非电影特效，而是真实发生过的人类悲剧——**踩踏事件 (Stampedes)**。

*   2010年德国杜伊斯堡“爱的大游行”音乐节踩踏事件。
*   1989年英国希尔斯堡惨案。
*   1985年比利时海瑟尔体育场惨案。

在这些事件中，成百上千的人聚集在狭小的空间里，当恐慌蔓延时，个体的理性迅速被群体的非理性行为所吞噬，导致了无法挽回的悲剧。

这些灾难向我们提出了一个严肃而紧迫的问题：

*   **羊群效应可以是致命的**。在恐慌状态下，人的行为会变得笨拙、危险，甚至会伤害他人。
*   **获取真实恐慌数据极其困难**。我们不可能为了研究而去故意制造一场灾难。
*   **公共安全意义重大**。体育场、音乐会、地铁站……这些高密度人群聚集地都存在潜在风险。

因此，**建立一个能够有效模拟人群，特别是恐慌人群行为的模型，对于公共安全预警、建筑设计评估、应急疏散方案制定，都具有至关重要的意义。**

#### **2\. 解决方案：社会力模型 (Social Force Model)**

为了应对这一挑战，德国物理学家**Dirk Helbing**教授及其合作者在2000年于《Nature》杂志上发表了一篇里程碑式的论文：《Simulating dynamical features of escape panic》。他们提出了一个极具创新性的概念——**社会力模型**。

**核心思想：** 将复杂的、难以量化的**社会心理学影响**，类比为物理世界中可以计算的\*\*“力”\*\*，并将其整合到经典的牛顿动力学框架中。

**基本原理：**

1.  **把人抽象为自我驱动的质点**。每个人都有质量、位置、速度。
2.  **每个人的运动都遵循牛顿第二定律**：$m\\vec{a} = \\vec{F}\_{total}$。
3.  这个合力 $\\vec{F}\_{total}$ 不再仅仅是物理力，它由三部分构成：
    *   **主观意识**产生的**自身驱动力**。
    *   来自**其他行人**的**相互作用力**。
    *   来自**障碍物（如墙壁）**的**环境作用力**。

现在，让我们用数学的语言来精确描述这个模型。

#### **3\. 模型的数学详解**

一个行人 $i$ 的运动方程可以写成：

$$m\_i \\frac{d\\vec{v}\_i}{dt} = \\vec{f}\_i^0 + \\sum\_{j(\\neq i)} \\vec{f}\_{ij} + \\sum\_{w} \\vec{f}\_{iw}$$

其中：

*   $m\_i$: 行人 $i$ 的质量。
*   $\\vec{v}\_i(t)$: 行人 $i$ 在时刻 $t$ 的实际速度。
*   $\\vec{r}\_i(t)$: 行人 $i$ 在时刻 $t$ 的位置。
*   $\\frac{d\\vec{v}\_i}{dt}$: 行人 $i$ 的加速度。

等式右边的三项力分别是：**自身驱动力**、**行人间的相互作用力**和**与障碍物的作用力**。

**3.1 个体的自身驱动力 $\\vec{f}\_i^0$**

这项力代表了行人想要到达目的地的**主观动机**。

**直觉**：每个人都有一个期望的行走速度和方向。如果我的当前速度与期望速度不符，我就会“发力”来调整，试图在一定时间内（称为“特征时间”或“反应时间”）恢复到我期望的状态。

**公式**： $$\\vec{f}\_i^0(t) = m\_i \\frac{v\_i^0(t)\\vec{e}\_i^0(t) - \\vec{v}\_i(t)}{\\tau\_i}$$

*   $v\_i^0(t)$: 行人 $i$ 的**期望速率**（一个标量，比如1.2m/s）。
*   $\\vec{e}\_i^0(t)$: 行人 $i$ 的**期望运动方向**（一个单位向量）。
*   $v\_i^0(t)\\vec{e}\_i^0(t)$: 这就是行人 $i$ 的**期望速度向量**。
*   $\\vec{v}\_i(t)$: 行人 $i$ 的**当前实际速度向量**。
*   $\\tau\_i$: 特征时间（或称反应时间），表示行人 $i$ 调整到期望速度所需的时间，通常取0.5秒左右。

**期望方向如何计算？** 很简单，它就是从当前位置指向最终目标位置的单位向量。 如果目标点位置为 $\\vec{p}$，行人当前位置为 $\\vec{r}\_i$，则： $\\vec{e}\_i^0(t) = \\frac{\\vec{p} - \\vec{r}\_i}{||\\vec{p} - \\vec{r}\_i||}$

这个驱动力是整个模型的“引擎”，它体现了行人运动的目的性。

**3.2 个体对个体产生的力 $\\vec{f}\_{ij}$**

这是模型中最复杂也最精妙的部分，它同时包含了**心理层面**的排斥和**物理层面**的接触。

$$\\vec{f}\_{ij} = { A\_i \\exp\[(r\_{ij} - d\_{ij}) / B\_i\] + k g(r\_{ij} - d\_{ij}) } \\vec{n}\_{ij} + \\kappa g(r\_{ij} - d\_{ij}) \\Delta v\_{ji}^t \\vec{t}\_{ij}$$

这个公式看起来很吓人，但别担心，我们把它拆解成三个部分：

graph TD F\_ij\["f\_ij (总作用力)"\] --> F\_psych\["心理排斥力 (Social)"\]; F\_ij --> F\_body\["身体接触力 (Contact)"\]; F\_ij --> F\_fric\["滑动摩擦力 (Friction)"\]; style F\_ij fill:#f9f,stroke:#333,stroke-width:2px

*   $r\_{ij} = r\_i + r\_j$: 两个行人半径之和。
*   $d\_{ij} = ||\\vec{r}\_i - \\vec{r}\_j||$: 两个行人中心点的距离。
*   $\\vec{n}\_{ij} = (\\vec{r}\_i - \\vec{r}\_j) / d\_{ij}$: 从行人 $j$ 指向行人 $i$ 的单位法向向量。
*   $\\vec{t}\_{ij}$: 与 $\\vec{n}\_{ij}$ 垂直的单位切向向量。

**a) 心理排斥力 (Psychological Repulsion Force)**

$$A\_i \\exp\[(r\_{ij} - d\_{ij}) / B\_i\] \\vec{n}\_{ij}$$ 这部分是**纯粹的心理作用**，代表了我们日常生活中下意识与他人保持“社交距离”的行为。

*   它的方向是沿着两人中心连线向外的。
*   它的核心是**指数函数** $\\exp()$。这意味着当两个人离得很远时($d\_{ij} \\gg r\_{ij}$)，这个力几乎为零；但当他们迅速靠近时，这个排斥力会**指数级增长**，产生一个强烈的“刹车”或“避让”效果。
*   $A\_i$ 和 $B\_i$ 是常数，分别控制了相互作用的强度和距离范围。

**b) 身体接触力 (Body Force)**

$$k g(r\_{ij} - d\_{ij}) \\vec{n}\_{ij}$$ 这部分是**物理接触**。

*   $g(x) = \\max(0, x)$。这个函数是关键：
    *   当 $r\_{ij} \\le d\_{ij}$ 时，即两人还未接触或正好相切，$g(x)=0$，**身体接触力为零**。
    *   当 $r\_{ij} > d\_{ij}$ 时，即两人模型发生重叠（代表身体挤压），$g(x) > 0$，**身体接触力被激活**。
*   这个力的大小与身体的“压缩量” ($r\_{ij} - d\_{ij}$) 成正比，模拟了身体被挤压时的弹力。$k$ 是一个很大的刚度常数。

**c) 滑动摩擦力 (Sliding Friction Force)**

$$\\kappa g(r\_{ij} - d\_{ij}) \\Delta v\_{ji}^t \\vec{t}\_{ij}$$ 这个力也是在物理接触时 ($g(x)>0$) 才存在。

*   它的作用是**防止人与人之间发生不真实的“滑过”现象**。
*   $\\Delta v\_{ji}^t = (\\vec{v}\_j - \\vec{v}\_i) \\cdot \\vec{t}\_{ij}$ 是两人在切线方向上的速度差。
*   当两人发生挤压并有相对切向运动时，会产生一个阻碍这种滑动的摩擦力。$\\kappa$ 是摩擦系数。

**3.3 环境力（与障碍物的作用力）$\\vec{f}\_{iw}$**

墙壁和障碍物对人的作用力，可以被建模成一个半径无限大的“行人”。因此，其公式与 $\\vec{f}\_{ij}$ 非常相似，只是没有心理排斥的指数项（人不会和墙保持社交距离），主要由物理接触力和摩擦力构成。

$$\\vec{f}\_{iw} = { k g(r\_i - d\_{iw}) } \\vec{n}\_{iw} + \\kappa g(r\_i - d\_{iw}) (\\vec{v}\_i \\cdot \\vec{t}\_{iw}) \\vec{t}\_{iw}$$

**3.4 模型的惊人发现：“欲速则不达”效应**

Helbing通过仿真这个模型，发现了一个非常重要的、反直觉的现象：**Faster-is-slower effect (欲速则不达效应)**。

*   在一个模拟房间疏散的实验中，他让行人以不同的期望速度 $v\_0$ 逃离。
*   **直觉认为**：期望速度越快，逃离得应该越快。
*   **仿真结果**：当期望速度 $v\_0$ 超过某个临界值后，出口处会迅速形成“拱形”堵塞，人群像沙漏里的沙子一样卡住。结果，**总的疏散时间反而变长了**，受伤人数也急剧增加。

这个结果告诉我们，在紧急疏散时，单纯地强调“快跑”可能会适得其反，维持秩序、避免在出口过度拥挤才是提高疏散效率的关键。

**3.5 羊群效应 (Herding Effect)**

在恐慌状态下，人们往往会盲目跟随大流，而不是独立思考最佳路径。社会力模型通过引入一个“恐慌参数” $p\_i$ 来模拟这种行为。

行人的期望运动方向 $\\vec{e}\_i^0$ 不再是单纯地指向出口，而是变成了**个体目标**和**邻居平均方向**的加权平均：

$$\\vec{e}\_i^0(t) = \\mathrm{Norm}\[ (1-p\_i)\\vec{e}\_{i, \\mathrm{individual}} + p\_i \\langle \\vec{e}\_j^0(t) \\rangle\_i \]$$

*   $p\_i=0$ 时，行人完全理性，只朝自己的目标前进。
*   $p\_i=1$ 时，行人完全丧失个体目标，纯粹跟随周围的人。

仿真表明，随着恐慌参数 $p$ 的增大，即使有多个出口，人群也会不成比例地涌向某一个出口，导致其他出口被闲置，整体疏散效率大大降低。

#### **4\. 代码实现思路**

**数据结构**

```
#include <vector>

                struct Vector2D { /* ... */ };

                class Pedestrian {
                public:
                    int id;
                    double mass;
                    double radius;
                    Vector2D position;
                    Vector2D velocity;
                    Vector2D desired_direction;
                    double desired_speed;
                    
                    // Social Force Model parameters
                    double tau, A, B, k, kappa;

                    void update(const Vector2D& total_force, double dt) {
                        Vector2D acceleration = total_force / mass;
                        velocity = velocity + acceleration * dt;
                        // Apply speed limit if needed
                        position = position + velocity * dt;
                    }
                };

                class Wall { /* ... defines a line segment ... */ };
                
```

**主循环伪代码**

```
void simulate_step(double dt) {
                    for (Pedestrian& ped_i : pedestrians) {
                        // 1. Calculate Driving Force
                        Vector2D desired_velocity = ped_i.desired_direction * ped_i.desired_speed;
                        Vector2D driving_force = (desired_velocity - ped_i.velocity) * ped_i.mass / ped_i.tau;
                        
                        Vector2D total_force = driving_force;

                        // 2. Calculate Interaction Forces from other pedestrians
                        for (const Pedestrian& ped_j : pedestrians) {
                            if (ped_i.id == ped_j.id) continue;
                            // ... calculate f_ij based on the full formula ...
                            total_force += calculate_interaction_force(ped_i, ped_j);
                        }

                        // 3. Calculate Interaction Forces from walls
                        for (const Wall& wall : walls) {
                            // ... calculate f_iw ...
                            total_force += calculate_wall_force(ped_i, wall);
                        }

                        // 4. Update pedestrian's state
                        ped_i.update(total_force, dt);
                    }
                }
                
```

### **第二部分：相互速度障碍物 (RVO) - 优雅的局部避障**

社会力模型非常适合模拟高密度、充满物理接触的人群。但是，对于中低密度下、需要进行平滑、无碰撞路径规划的场景（比如机器人导航、游戏角色的日常移动），我们需要一种更侧重于**预判**和**几何**的方法。

这就是**速度障碍物 (Velocity Obstacles, VO)** 和其改进版 **相互速度障碍物 (Reciprocal Velocity Obstacles, RVO)** 的用武之地。

#### **1\. 背景与问题描述**

**核心问题**：在一个共享环境中，N个智能体都想从各自的起点移动到终点，如何保证它们在运动过程中**相互不发生碰撞**？

*   这是一个**解耦 (Decoupled)** 的方法：每个智能体独立为自己进行导航决策。
*   它关注的是**局部导航**：我只关心在下一瞬间，我该如何调整速度来避免与眼前的邻居相撞。

#### **2\. 速度障碍物 (VO) 的核心思想**

想象一下，我是智能体A，正前方有一个智能体B。

**VO要回答的问题是：在速度空间中，哪些速度是我（A）不能选择的，因为选择它们未来必然会导致和B相撞？**

这个“禁区”的集合，就是B为A构建的**速度障碍物** $VO\_B^A$。

**几何推导**：

1.  **相对速度**：碰撞是否发生，只取决于两者的**相对位置**和**相对速度**。让我们以A为参照系，A静止，B以相对速度 $\\vec{v}\_B - \\vec{v}\_A$ 运动。
2.  **碰撞区域**：如果B的运动轨迹（一条射线）穿过了以A为中心、半径为 $r\_A+r\_B$ 的圆盘，那么就会发生碰撞。
3.  **闵可夫斯基和 (Minkowski Sum)**：在几何上，这个碰撞区域可以被优雅地描述为A和B的**闵可夫斯基和**。将B的形状（一个圆）围绕-A的形状（也是一个圆）的边界“滚动”一圈所扫过的区域。对于两个圆盘，其闵可夫斯基和是一个半径为 $r\_A+r\_B$ 的大圆盘。
4.  **速度障碍物锥 (VO Cone)**：在速度空间中，从原点（代表A的当前速度）向这个闵可夫斯基和区域张开的所有射线，就构成了一个**锥形区域**。这个锥，就是 $VO\_B^A$。

**结论**：如果A选择的速度 $\\vec{v}\_A$ 位于 $VO\_B^A(\\vec{v}\_B)$ 内部，则A和B未来必然碰撞。为了避障，A必须选择一个在锥外部的速度。

#### **3\. VO的致命缺陷：振荡 (Oscillation)**

如果A和B都是智能体，它们都会为对方计算VO并尝试避让，会发生什么？ **灾难性的振荡！**

请看这个过程：

1.  A和B正对向行驶。
2.  **时刻t**：A计算出B的VO，决定向右转。B计算出A的VO，也决定向右转（从它自己的角度看）。
3.  **时刻t+1**：A的新速度已经避开了B的旧VO。但因为B也动了，B的新速度又为A创造了一个新的VO，A发现自己又在新VO里了！于是A再次调整。
4.  **循环往复**：两者可能会在对方面前像钟摆一样来回晃动，无法做出有效避让，路径变得非常难看和低效。

**原因**：每个智能体都把**全部的避障责任**推给了对方，它假设对方会保持当前速度不变，而没有考虑到对方也在智能地避让。

#### **4\. RVO的解决方案：责任共担 (Shared Responsibility)**

RVO的核心思想是：**我们不要互相推诿，让我们一人一半，共同承担避障的责任。**

**实现**： 在计算VO时，不再假设对方速度不变。而是假设，为了避障，我和对方将以某种方式协调我们的速度变化。最简单、最公平的协调方式就是：**我们共同努力，将最终的相对速度调整到VO锥的边界上。**

**几何解释**： 这相当于将原来顶点在 $\\vec{v}\_B$ 的VO锥，平移到新的顶点 $\\frac{\\vec{v}\_A + \\vec{v}\_B}{2}$ 处。这个新的锥，就是**相互速度障碍物 $RVO\_B^A$**。

**$$RVO\_B^A(\\vec{v}\_B, \\vec{v}\_A) = { \\vec{v}' | 2\\vec{v}' - \\vec{v}\_A \\in VO\_B^A(\\vec{v}\_B) }$$** (这公式的几何意义就是把速度 $\\vec{v}'$ 放大两倍再减去 $\\vec{v}\_A$ 来看是否在原VO内，等价于平移)

**为什么RVO能解决振荡？** 因为它是**互惠的**。如果A选择了它的RVO边界上的一个新速度 $\\vec{v}\_A'$，同时B也选择了它的RVO边界上的一个新速度 $\\vec{v}\_B'$，那么这两个选择是**兼容的**，它们的新的相对速度 $(\\vec{v}\_A' - \\vec{v}\_B')$ 刚好会落在原始碰撞锥的边界上，从而实现“擦肩而过”的平滑避让。振荡消失了！

**广义RVO (ORCA - Optimal Reciprocal Collision Avoidance)** 更进一步，避障的责任不一定是50/50。我们可以引入一个参数 $\\alpha$ 来分配责任。比如，根据社会地位、质量、或者紧急程度来决定谁应该做出更多的避让。这就是ORCA的核心思想，它在RVO的基础上提供了更灵活的控制。

**实验对比**： 在一个经典的“圆圈”实验中，让N个智能体均匀分布在一个圆上，每个智能体的目标是到达圆的正对面。

*   使用**VO**：智能体在圆心附近挤作一团，路径混乱不堪，充满抖动和振荡。
*   使用**RVO/ORCA**：智能体们会自发形成一个美丽的、旋转的涡旋，平滑、高效、无碰撞地到达各自的目标。这是一个非常震撼的涌现现象。

### **第三部分：连续人群 (Continuum Crowds) - 宏观的流动**

无论是社会力模型还是RVO，它们都属于**基于智能体 (agent-based)** 的方法，核心是模拟每个独立的个体。当人群密度极高，个体的自由意志被群体流动所主导时，我们可以换一个视角。

**核心思想**：不再把人群看作是离散的“粒子”集合，而是把它看作一种**连续的介质**，像水流一样。我们不去计算每个人的力或速度，而是去计算整个空间中的\*\*“场”\*\*。

#### **1\. 方法流程**

1.  **离散化**：将场景划分为一个**网格 (Grid)**。
2.  **计算场**：在网格上计算各种“场”：
    *   **密度场 $\\rho(\\vec{x})$**：每个格子有多少人。
    *   **速度场 $\\vec{v}(\\vec{x})$**：每个格子的人的平均速度。
    *   **代价场 $C(\\vec{x})$**：在每个格子行走的“成本”是多少。
    *   **势能场 $\\phi(\\vec{x})$**：从每个格子走到终点的“最小总成本”。
3.  **更新**：根据势能场的梯度来驱动人群的流动。

#### **2\. 核心数学：最优路径与势能场**

**a) 定义代价 (Cost)** 我们希望行人选择一条“最优”路径。什么是最优？可能是**路程最短**，也可能是**时间最短**，或者是**最舒服**。 我们可以定义一个总代价 $E$，它是这三者的加权和： $$E(P) = \\int\_P \\alpha , ds + \\int\_P \\beta , dt + \\int\_P \\gamma g , dt$$

*   $\\int ds$ 是路径长度。
*   $\\int dt$ 是时间。
*   $\\int g dt$ 是“不舒服度”的累积（比如，$g$ 在人多的地方值就高）。

因为速度 $f = ds/dt$，所以 $dt = ds/f$。代入上式，我们可以把所有东西都统一到对路径长度的积分上： $E(P) = \\int\_P (\\alpha + \\frac{\\beta}{f} + \\frac{\\gamma g}{f}) , ds = \\int\_P C(\\vec{x}) , ds$ 这个 $C(\\vec{x}) = \\frac{\\alpha f + \\beta + \\gamma g}{f}$ 就是**单位代价场**。它表示在点 $\\vec{x}$ 处，走单位长度需要付出的综合成本。

**b) 求解势能场 $\\phi$** 现在，我们定义一个**势能场 $\\phi(\\vec{x})$**，它的值等于从点 $\\vec{x}$ 出发，沿着最优路径到达目标的**最小总代价**。 这个势能场满足一个著名的偏微分方程——**Eikonal方程**： $$||\\nabla \\phi(\\vec{x})|| = C(\\vec{x})$$

*   **直观理解**：势能场梯度的“陡峭程度”，就等于该地的行走“成本”。
*   在目标点，$\\phi=0$。我们可以用快速行进法（Fast Marching Method）等数值方法高效地求解这个方程，得到整个场景的势能场。

**c) 驱动人群运动** 有了势能场，行人的最优运动方向就变得异常简单：沿着势能下降最快的方向，即**负梯度方向**。 $$\\vec{\\dot{x}} = -f(\\vec{x}, \\theta) \\frac{\\nabla \\phi(\\vec{x})}{||\\nabla \\phi(\\vec{x})||}$$ 每个人就像一个放在势能曲面上的小球，会自动地滚向最低点（目标）。

#### **3\. 优缺点**

*   **优点**：
    *   运动路径非常光滑，天然避免了agent-based方法中的冲突和抖动。
    *   能很好地刻画一些宏观现象，如人行道的形成、拥塞时的涡旋。
    *   计算效率高，尤其适合超大规模人群的全局路径规划。
*   **缺点**：
    *   **缺少个体性**。所有在同一个格子的人行为都一样，难以表现个体差异。
    *   **不适用于未知环境**。它假设了人群对全局的代价场是预知的。
    *   **惯性缺失**。速度方向可以瞬间改变，缺乏物理真实感。

在实践中，连续人群模型常常被用来计算一个宏观的引导流场，然后agent-based模型在这个流场的引导下，再进行局部的、富有个性的行为模拟。